name: Test, Build and Release
run-name: Test, Build and Release ${{ inputs.release-version }}

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, labeled, synchronize]
  workflow_dispatch:
    inputs:
      build-type:
        description: 'Type of build to perform'
        required: true
        default: 'release'
        type: choice
        options:
          - build
          - size-analysis
          - release
      release-version:
        description: 'The version to release (e.g., 1.2.3). The "v" prefix is added automatically.'
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Format, analyze and test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout app repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          path: app

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          cache: true

      - name: Install pub dependencies
        run: flutter pub get

      - name: Check dart format
        run: dart format --set-exit-if-changed .

      - name: Analyze flutter
        run: flutter analyze

      - name: Run tests
        run: flutter test

  build:
    name: Build app
    needs: test
    if: ${{ ( startsWith(github.ref, 'refs/tags/')
      || contains(github.event.pull_request.labels.*.name, 'âš—ï¸ Request Build')
      || inputs.build-type ) }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app

    outputs:
      version_name: ${{ steps.build_options.outputs.version_name }}

    steps:
      - name: Checkout app repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          path: app

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          cache: true

      - name: Set up JDK
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Update pubspec.yaml version
        if: inputs.build-type == 'release' && inputs.release-version
        run: |
          flutter pub global activate pub_version_plus
          pubversion set ${{ inputs.release-version }}

      - name: Install pub dependencies
        run: flutter pub get

      - name: Set up keystore
        id: keystore
        if: github.repository == 'RubberDuckCrew/gitdone' && github.event.pull_request.head.repo.fork == false
        run: |
          {
            echo keyPassword=${{ secrets.KEY_PASSWORD }}
            echo storePassword=${{ secrets.KEYSTORE_PASSWORD }}
            echo keyAlias=${{ secrets.KEY_ALIAS }}
          } > android/key.properties
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/key.jks
          echo "signing_available=true" >> "$GITHUB_OUTPUT"

      - name: Set build options
        id: build_options
        run: |
          SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          VERSION="${{ github.event.inputs.release-version }}"
          VERSION_NAME="${VERSION:-$(echo "$GITHUB_REF_NAME" | tr / _)}_${SHORT_SHA}"
          VERSION_NAME="$(echo "$GITHUB_REF_NAME" | tr / _)_$SHORT_SHA"
          FLAVOR="${{ inputs.build-type == 'release' && 'production' || 'staging' }}"
          SKIP_SIGN="${{ steps.keystore.outputs.signing_available != 'true' && '-PskipSigning=true' || '' }}"
          {
            echo "flavor=$FLAVOR"
            echo "version_name=$VERSION_NAME"
            echo "build_args=--release --flavor $FLAVOR --dart-define=GIT_COMMIT=$SHORT_SHA --obfuscate --split-debug-info=build/app/symbols $SKIP_SIGN"
          } >> "$GITHUB_OUTPUT"

      - name: Build APK
        run: flutter build apk ${{ steps.build_options.outputs.build_args }}

      - name: Build app bundle
        run: flutter build appbundle ${{ steps.build_options.outputs.build_args }}

      - name: Build APK for size analysis
        if: inputs.build-type == 'size-analysis'
        run: flutter build apk ${{ steps.build_options.outputs.build_args }} --analyze-size --target-platform android-arm64

      - name: Rename build artifacts
        run: |
          mkdir -p ../build-artifacts
          mv build/app/outputs/flutter-apk/app-${{ steps.build_options.outputs.flavor }}-release.apk ../build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.apk
          mv build/app/outputs/bundle/${{ steps.build_options.outputs.flavor }}Release/app-${{ steps.build_options.outputs.flavor }}-release.aab ../build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.aab
          mv build/app/symbols ../build-artifacts/symbols

      - name: Upload APK
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: GitDone ${{ steps.build_options.outputs.version_name }} APK
          path: build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.apk

      - name: Upload app bundle
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: GitDone ${{ steps.build_options.outputs.version_name }} AAB
          path: build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.aab

      - name: Upload symbols file
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: GitDone ${{ steps.build_options.outputs.version_name }} Symbols
          path: build-artifacts/symbols

      - name: Upload size analysis apk
        if: inputs.build-type == 'size-analysis'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: Size Analysis APK ARM64
          path: /home/runner/.flutter-devtools/apk-code-size-analysis_01.json

      - name: Upload pubspec.yaml
        if: inputs.build-type == 'release' && inputs.release-version
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: pubspec.yaml
          path: app/pubspec.yaml

  post-request:
    name: Post requested build
    needs: build
    if: contains(github.event.pull_request.labels.*.name, 'âš—ï¸ Request Build') && github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Remove build request label
        uses: IamPekka058/removeLabels@82c8d070189f04448d6ffe291a0e398c2a749a09 # v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: 'âš—ï¸ Request Build'

      - name: Comment artifact links
        uses: RubberDuckCrew/artifact2pr@bc4223cc428e7f58d4278de0372c679688710aa4 # v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-if-no-artifacts: true

  release:
    name: Create release
    needs: build
    if: inputs.build-type == 'release' && inputs.release-version
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Check if secrets are available
        id: check-secrets
        run: |
          echo "secrets_available=${{
            vars.RUBBERDUCKCREW_BOT_APP_ID &&
            secrets.RUBBERDUCKCREW_BOT_APP_PRIVATE_KEY &&
            'true' || ''
          }}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub App token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        if: ${{ steps.check-secrets.outputs.secrets_available }}
        id: app-token
        with:
          app-id: ${{ vars.RUBBERDUCKCREW_BOT_APP_ID }}
          private-key: ${{ secrets.RUBBERDUCKCREW_BOT_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          token: ${{ steps.app-token.outputs.token || github.token }}

      - name: Download pubspec.yaml
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: pubspec.yaml

      - name: Commit pubspec.yaml
        uses: suzuki-shunsuke/commit-action@87b297f0ce551411b43d1880f4fb3cbc60381055 # v0.0.14
        with:
          commit_message: 'ðŸ”– Release v${{ inputs.release-version }} [skip ci]'
          files: 'pubspec.yaml'
          github_token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
          fail_on_self_push: false

      - name: Download APK artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: GitDone ${{ needs.build.outputs.version_name }} APK

      - name: Download app bundle artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: GitDone ${{ needs.build.outputs.version_name }} AAB

      - name: Download symbols artifact
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
        with:
          name: GitDone ${{ needs.build.outputs.version_name }} Symbols

      - name: Zip symbols folder
        run: |
          zip -r "GitDone_${{ needs.build.outputs.version_name }}_Symbols.zip" ./*.symbols

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: 'v${{ inputs.release-version }}'
          name: 'ðŸ”– v${{ inputs.release-version }}'
          draft: true
          prerelease: false
          files: |
            GitDone_${{ needs.build.outputs.version_name }}.apk
            GitDone_${{ needs.build.outputs.version_name }}.aab
            GitDone_${{ needs.build.outputs.version_name }}_Symbols.zip
