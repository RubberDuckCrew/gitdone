name: Test, Build and Release

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    types: [ opened, labeled, synchronize ]
  workflow_dispatch:
    inputs:
      build-type:
        description: 'Type of build to perform'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - build
          - size-analysis

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Format, analyze and test
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app

    steps:
      - name: Checkout app repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          path: app

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          cache: true

      - name: Sync Dart SDK version
        uses: IamPekka058/flutter-dart-sync@82d6343523d0774645d651ebed03ea0600b78668 # v0
        with:
          pubspec_path: app/pubspec.yaml

      - name: Install pub dependencies
        run: flutter pub get

      - name: Check dart format
        run: dart format --set-exit-if-changed .

      - name: Analyze flutter
        run: flutter analyze

      - name: Run tests
        run: flutter test

  build:
    name: Build app
    needs: test
    if: ${{ ( startsWith(github.ref, 'refs/tags/')
        || contains(github.event.pull_request.labels.*.name, '⚗️ Request Build')
        || inputs.build-type == 'build' || inputs.build-type == 'size-analysis' ) }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app

    outputs:
      version_name: ${{ steps.build_options.outputs.version_name }}

    steps:
      - name: Checkout app repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          path: app

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          cache: true

      - name: Sync Dart SDK version
        uses: IamPekka058/flutter-dart-sync@82d6343523d0774645d651ebed03ea0600b78668 # v0
        with:
          pubspec_path: app/pubspec.yaml

      - name: Set up JDK
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install pub dependencies
        run: flutter pub get

      - name: Set up keystore
        id: keystore
        if: github.repository == 'RubberDuckCrew/gitdone' && github.event.pull_request.head.repo.fork == false
        run: |
          {
            echo "keyPassword=${{ secrets.KEY_PASSWORD }}"
            echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}"
            echo "keyAlias=${{ secrets.KEY_ALIAS }}"
          } > android/key.properties
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/key.jks
          echo "signing_available=true" >> "$GITHUB_OUTPUT"

      - name: Set build options
        id: build_options
        run: |
          SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          VERSION_NAME="$(echo "$GITHUB_REF_NAME" | tr / _)_$SHORT_SHA"
          FLAVOR="${{ startsWith(github.ref, 'refs/tags/') && 'production' || 'staging' }}"
          SKIP_SIGN="${{ steps.keystore.outputs.signing_available != 'true' && '-PskipSigning=true' || '' }}"
          {
            echo "flavor=$FLAVOR"
            echo "version_name=$VERSION_NAME"
            echo "build_args=--release --flavor $FLAVOR --dart-define=GIT_COMMIT=$SHORT_SHA --obfuscate --split-debug-info=build/app/symbols $SKIP_SIGN"
          } >> "$GITHUB_OUTPUT"

      - name: Build APK
        run: flutter build apk ${{ steps.build_options.outputs.build_args }}

      - name: Build app bundle
        run: flutter build appbundle ${{ steps.build_options.outputs.build_args }}

      - name: Build APK for size analysis
        if: inputs.build-type == 'size-analysis'
        run: flutter build apk ${{ steps.build_options.outputs.build_args }} --analyze-size --target-platform android-arm64

      - name: Rename build artifacts
        run: |
          mkdir -p ../build-artifacts
          mv build/app/outputs/flutter-apk/app-${{ steps.build_options.outputs.flavor }}-release.apk ../build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.apk
          mv build/app/outputs/bundle/${{ steps.build_options.outputs.flavor }}Release/app-${{ steps.build_options.outputs.flavor }}-release.aab ../build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.aab
          mv build/app/symbols ../build-artifacts/symbols

      - name: Upload APK
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: GitDone ${{ steps.build_options.outputs.version_name }} APK
          path: build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.apk

      - name: Upload app bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: GitDone ${{ steps.build_options.outputs.version_name }} AAB
          path: build-artifacts/GitDone_${{ steps.build_options.outputs.version_name }}.aab

      - name: Upload symbols file
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: GitDone ${{ steps.build_options.outputs.version_name }} Symbols
          path: build-artifacts/symbols

      - name: Upload size analysis apk
        if: inputs.build-type == 'size-analysis'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: Size Analysis APK ARM64
          path: /home/runner/.flutter-devtools/apk-code-size-analysis_01.json

  post-request:
    name: Post requested build
    needs: build
    if: contains(github.event.pull_request.labels.*.name, '⚗️ Request Build') && github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Remove build request label
        uses: IamPekka058/removeLabels@82c8d070189f04448d6ffe291a0e398c2a749a09 # v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: '⚗️ Request Build'

      - name: Comment artifact links
        uses: RubberDuckCrew/artifact2pr@bc4223cc428e7f58d4278de0372c679688710aa4 # v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-if-no-artifacts: true

  post-build-tagged:
    name: Post tagged build
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: GitDone ${{ needs.build.outputs.version_name }} APK

      - name: Download app bundle artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: GitDone ${{ needs.build.outputs.version_name }} AAB

      - name: Download symbols artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: GitDone ${{ needs.build.outputs.version_name }} Symbols

      - name: Zip symbols folder
        run: |
          zip -r "GitDone_${{ needs.build.outputs.version_name }}_Symbols.zip" ./*.symbols

      - name: Release artifacts
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            GitDone_${{ needs.build.outputs.version_name }}.apk
            GitDone_${{ needs.build.outputs.version_name }}.aab
            GitDone_${{ needs.build.outputs.version_name }}_Symbols.zip
